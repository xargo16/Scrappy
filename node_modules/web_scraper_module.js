//External modules
const request = require('request');
const cheerio = require("./cheerio");

//My modules
const company_details_parser = require('company_details_parser_module');

function startScraping(websiteUrl){
  request(websiteUrl, function (error, response, body) {
    const $ = cheerio.load(body);
    var urlToContactPage = getUrlToContactUsWebPage($);

    //If there is url to contact us page then use that page to scrap for company
    //details instead of using index page
    if(urlToContactPage){
      //Concatenation of websiteUrl and url from <a> element is needed, because
      //value returned from this element is relative URL
      urlToContactPage = websiteUrl + urlToContactPage;

      request(urlToContactPage, function (error, response, body) {
            const $ = cheerio.load(body);
            printDetailsAboutCompany($);
      });
    }
    else{
      printDetailsAboutCompany($);
    }
  });
}

//Check if there is any <a> element on the web page that contains "contact" word
//in it's text. If yes than return the link
function getUrlToContactUsWebPage($){
  var contactURL = "";
  $("a").each(function(i, elem){
    var text = $(this).text();
    var regex = /contact/i;

    if(regex.test(text)){
        contactURL = $(this).attr('href');
    }
  });
  return contactURL;
}

function printDetailsAboutCompany($){
  var entireTextFromTheWebPage = $('body').text();

  console.log("Information scrapped:");
  console.log(company_details_parser.getCompanyDetailsFromString(entireTextFromTheWebPage));
}

module.exports = {
  startScraping: startScraping
};
